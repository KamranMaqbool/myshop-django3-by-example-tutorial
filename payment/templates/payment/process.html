{% extends "shop/base.html" %}

{% block title %}Pay by credit card {% endblock %}

{% block content %}
<h1>Pay by credit card</h1>
<form id="payment" method="post">
    <label for="cart-number">Card Number</label>
    <div id="cart-number" class="field"></div>

    <label for="ccv">CCV</label>
    <div id="ccv" class="field"></div>

    <label for="expiration-date">Expiration Date</label>
    <div id="expiration-date" class="field"></div>

    <input type="hidden" id="nonce" name="payment_method_nonce" value="">
    {% csrf_toke %}
    <input type="submit" value="Pay" disabled>
</form>
<!-- includes the Braintree JS client SDK -->
<script src="https://js.braintreegateway.com/web/3.85.5/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.85.5/js/hosted-fields.min.js"></script>

<!-- includes jQuery -->
<script src="http://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>

<script>
    var form = document.querySelector("#payment")
    var submit = document.querySelector('input[type="submit"]')

    braintree.client.create({
        // Insert your tokenization key here
        authorization: '{{ client_token }}'
    }, function(clientErr, clientInstance) {
        if(clientErr) {
            console.log(clientErr)
            return;
        }

        // Create a hostedFields component to initialize the form
        braintree.hostedFields.create({
            // Customize the Hosted Fields.
            // More information can be found at:
            // https://developers.braintreepayments.com/guides/hosted-fields/styling/javascript/v3

            styles: {
                'input': {
                    'font-size': '14px'
                },
                'input.invalid': {
                    'color': 'red'
                },
                'input.valid': {
                    'color': 'green'
                }
            },

            // Configure which fields in your card form will be generated by Hosted Fields instead

            fields: {
                number: {
                    container: '#card-number',
                    placeholder: '4111 1111 1111 1111'
                },
                cvv: {
                    container: '#cvv',
                    placeholder: '123'
                },
                expirationDate: {
                    container: '#expiration-date',
                    placeholder: '10/2022'
                }
            }
        }, function(hostedFieldErr, instance){
            if(hostedFieldErr){
                console.log(hostedFieldErr)
                return;
            }

            // Once the fields are initialized enable the submit button
            submit.removeAttribute('disabled')

            // Initialize the form submit event
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                // When the user clicks on the 'Submit payment' button this code will send the
                // encrypted payment information in a variable called a payment method nonce
                
                instance.tokenize(function(tokenizeErr, payload){
                    if(tokenizeErr) {
                        console.log(tokenizeErr)
                        return;
                    }
                    // set nonce to send to the server
                    document.getElementById('nonce').value = payload.nonce;
                    // submit form
                    document.getElementById('payment').submit()
                });
            }, false);
        });
    });
</script>
{% endblock %}